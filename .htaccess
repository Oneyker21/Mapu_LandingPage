# Configuraciones de seguridad para Apache
# Archivo .htaccess para la landing page de Mapu

# ===========================================
# HEADERS DE SEGURIDAD
# ===========================================

# Prevenir clickjacking
Header always set X-Frame-Options "DENY"
Header always set X-Content-Type-Options "nosniff"

# Protección XSS
Header always set X-XSS-Protection "1; mode=block"

# Política de referrer
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Content Security Policy
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self' mailto:;"

# Política de permisos
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"

# Strict Transport Security (HSTS) - Solo si usas HTTPS
# Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# ===========================================
# PROTECCIÓN DE ARCHIVOS SENSIBLES
# ===========================================

# Bloquear acceso a archivos de configuración
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|sql|conf)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Bloquear acceso a archivos de sistema
<FilesMatch "^\.">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Proteger archivos de backup
<FilesMatch "\.(bak|backup|old|tmp|temp)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# ===========================================
# CONFIGURACIONES DE SEGURIDAD GENERAL
# ===========================================

# Deshabilitar el listado de directorios
Options -Indexes

# Deshabilitar el seguimiento de símbolos
Options -FollowSymLinks

# Ocultar información del servidor
ServerTokens Prod
Header unset Server
Header unset X-Powered-By

# ===========================================
# PROTECCIÓN CONTRA ATAQUES COMUNES
# ===========================================

# Bloquear user agents maliciosos
RewriteEngine On
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC,OR]
RewriteCond %{THE_REQUEST} \?\ HTTP/ [NC,OR]
RewriteCond %{THE_REQUEST} \/\*\ HTTP/ [NC,OR]
RewriteCond %{THE_REQUEST} etc/passwd [NC,OR]
RewriteCond %{THE_REQUEST} cgi-bin [NC,OR]
RewriteCond %{THE_REQUEST} (%0A|%0D) [NC]
RewriteRule .* - [F]

# Bloquear intentos de inyección SQL
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} ^.*(\[|\]|\(|\)|<|>|ê|"|;|\?|\*|=$).* [NC,OR]
RewriteCond %{QUERY_STRING} (NULL|OUTFILE|LOAD_FILE) [OR]
RewriteCond %{QUERY_STRING} (\./|\../|\.../)+(motd|etc|bin) [NC,OR]
RewriteCond %{QUERY_STRING} (localhost|loopback|127\.0\.0\.1) [NC,OR]
RewriteCond %{QUERY_STRING} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{QUERY_STRING} concat[^\(]*\( [NC,OR]
RewriteCond %{QUERY_STRING} union([^s]*s)+elect [NC,OR]
RewriteCond %{QUERY_STRING} union([^a]*a)+ll([^s]*s)+elect [NC,OR]
RewriteCond %{QUERY_STRING} (;|<|>|'|"|\)|%0A|%0D|%22|%27|%3C|%3E|%00).*(/\*|union|select|insert|drop|delete|update|cast|create|char|convert|alter|declare|order|script|set|md5|benchmark|encode) [NC,OR]
RewriteCond %{QUERY_STRING} (sp_executesql) [NC]
RewriteRule .* - [F]

# ===========================================
# COMPRESIÓN Y OPTIMIZACIÓN
# ===========================================

# Habilitar compresión GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# ===========================================
# CACHE Y EXPIRACIÓN
# ===========================================

# Configurar cache para archivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
</IfModule>

# ===========================================
# REDIRECCIONES Y REWRITE RULES
# ===========================================

# Forzar HTTPS (descomenta si tienes SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirigir www a no-www (o viceversa según tu preferencia)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# ===========================================
# LÍMITES DE TAMAÑO Y TIEMPO
# ===========================================

# Limitar tamaño de archivos subidos (si aplica)
LimitRequestBody 10485760

# Tiempo límite para scripts
TimeOut 30

# ===========================================
# LOGGING DE SEGURIDAD
# ===========================================

# Log de accesos sospechosos
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\"" security
CustomLog logs/security.log security

# ===========================================
# CONFIGURACIONES ADICIONALES
# ===========================================

# Deshabilitar métodos HTTP innecesarios
<LimitExcept GET POST HEAD>
    Order Allow,Deny
    Deny from all
</LimitExcept>

# Configurar tipos MIME
AddType application/javascript .js
AddType text/css .css

# Prevenir hotlinking de imágenes
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?tudominio\.com [NC]
RewriteRule \.(jpg|jpeg|png|gif|svg)$ - [F]
